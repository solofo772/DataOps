# DNSmasq configuration for internal DNS resolution

# Listen only on the WireGuard network interface
interface=eth0
bind-interfaces

# Domain and IP mappings
address=/minio.votre-domaine.com/10.8.0.3
address=/webapp.votre-domaine.com/10.8.0.4
address=/vpn.votre-domaine.com/10.8.0.1

# Forward other DNS requests to external DNS servers
server=1.1.1.1
server=8.8.8.8

version: '3.8'

services:
  wg-easy:
    image: ghcr.io/wg-easy/wg-easy
    container_name: wg-easy
    environment:
      - LANG=de
      - WG_HOST=192.168.1.131
#      - PASSWORD=123456789
      - PORT=51821
      - WG_PORT=51820
    volumes:
      - ~/.wg-easy:/etc/wireguard
    ports:
      - "51820:51820/udp"
      - "51821:51821/tcp"
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      net.ipv4.conf.all.src_valid_mark: 1
      net.ipv4.ip_forward: 1
    networks:
      wg-net:
    restart: unless-stopped

networks:
  wg-net:
    driver: bridge   


http:
  middlewares:
    vpn-restricted:
      ipWhiteList:
        sourceRange:
          - "10.8.0.0/24"  # Sous-r√©seau du VPN WireGuard

  routers:
    kafdrop-router:
      rule: "Host(`kafdrop.lesableblanc-manambato.mg`)"
      service: kafdrop-service
      middlewares:
        - "vpn-restricted"  # Appliquer la restriction IP VPN

    flink-router:
      rule: "Host(`flink.lesableblanc-manambato.mg`)"
      service: flink-service
      middlewares:
        - "vpn-restricted"  # Appliquer la restriction IP VPN


# Pour Kafdrop (port 9000)
iptables -A INPUT -p tcp --dport 9000 -s 10.8.0.0/24 -j ACCEPT
iptables -A INPUT -p tcp --dport 9000 -j REJECT

# Pour Flink (port 8082)
iptables -A INPUT -p tcp --dport 8082 -s 10.8.0.0/24 -j ACCEPT
iptables -A INPUT -p tcp --dport 8082 -j REJECT

  
